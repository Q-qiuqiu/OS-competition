# docker + k3s + fission

## 部署 docker

### 虚拟机（Ubuntu）

参考文章：[最详细的ubuntu 安装 docker教程-阿里云开发者社区 (aliyun.com)](https://developer.aliyun.com/article/1323800)

### openEuler

指令：`yum install -y docker`

## docker 换源

`vim /etc/docker/daemon.json`

```shell
{
    "registry-mirrors":[
       "https://hub-mirror.c.163.com/",
       "https://docker.mirrors.ustc.edu.cn/",
       "https://b9ukhwgq.mirror.aliyuncs.com",
       "https://docker.kubesre.xyz",
       "https://dockerhub.jobcher.com",
       "https://461da12941f64b7f97eda2cae45cf736.mirror.swr.myhuaweicloud.com",
       "https://4ll3sv09.mirror.aliyuncs.com"
    ]
}
```

推荐还是用阿里云注册一个免费的镜像源，相对还好用一点。

阿里云创建镜像源教程：[docker学习笔记（五）如何创建自己的阿里云镜像仓库（这是2021版的阿里云教程）_阿里云仓如何建设-CSDN博客](https://blog.csdn.net/a123123sdf/article/details/117373743)

```shell
# 重启 docker 以及 daemon
systemctl daemon-reload
systemctl restart docker
```

参考文章：

+ [无法愉快拉取 gcr.io、quay.io、ghcr.io 容器镜像？手把手教你用魔法来打败魔法-CSDN博客](https://blog.csdn.net/easylife206/article/details/124763001)

如果还是不可以拉取，则可以上 chrome 搜索“Docker Hub 镜像加速器”，寻找可用的源。

使用上面的源可能会出现多次重新拉取的信息，不用管，耐心等待即可，一次拉取不成功可以二次拉取。

### 国内部分镜像

[渡渡鸟镜像同步站 (aityp.com)](https://docker.aityp.com/)

## 部署 k3s

参考文章：[如何使用国内资源安装 K3s - 权威教程 - Rancher 中文论坛](https://forums.rancher.cn/t/k3s/3314)

```shell
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \
  INSTALL_K3S_MIRROR=cn \
  K3S_TOKEN=12345 sh -s - \
  --system-default-registry=registry.cn-hangzhou.aliyuncs.com
```

使用 docker 作为容器运行时

```shell
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \
  INSTALL_K3S_MIRROR=cn \
  K3S_TOKEN=12345 sh -s - --docker \
  --system-default-registry=registry.cn-hangzhou.aliyuncs.com
```

在部署集群的时候，参考[高级选项和配置 | Rancher文档](https://docs.rancher.cn/docs/k3s/advanced/_index)和[如何使用国内资源安装 K3s - 权威教程 - Rancher 中文论坛](https://forums.rancher.cn/t/k3s/3314)即可。

使用这个指令 kube-system 的 pod 都可以正常启动。

如果选择不使用这个指令，则可能需要在部署后，使用 `kubectl describe pod <pod-name> -n kube-system`来检查是哪个容器没有拉取成功，并使用可以拉取的源主动拉取。

## 部署 fission

参考文章：[Installing Fission | Fission](https://fission.io/docs/installation/)

使用指令：`kubectl version`查看 kubectl 的版本。

我们没有安装 helm，所以选择使用`Without helm`的方式安装 fission。

我们使用的是 k3s，所以选择使用`Basic with LoadBalancer`。

```shell
kubectl create -k "github.com/fission/fission/crds/v1?ref=v1.20.1"
export FISSION_NAMESPACE="fission"
kubectl create namespace $FISSION_NAMESPACE
kubectl config set-context --current --namespace=$FISSION_NAMESPACE
kubectl apply -f https://github.com/fission/fission/releases/download/v1.20.1/fission-all-v1.20.1.yaml
kubectl config set-context --current --namespace=default #to change context to default namespace after installation
```

安装 fission cli

使用的是 Linux 系统，所以使用以下指令：

```shell
curl -Lo fission https://github.com/fission/fission/releases/download/v1.20.1/fission-v1.20.1-linux-arm64 \
    && chmod +x fission && sudo mv fission /usr/local/bin/
```

查看 fission 的版本：`fission version`，或者检查 fission 是否安装成功：`fission check`，一般会报无法找到 KUBECONFIG 配置。

这是因为 k8s 中的这个文件在 ~/.kube/config，但是在 k3s 中，~/.kube/目录下没有这个内容。

这个时候可以使用：`kubectl get pods -v=6`指令进行查看，一般会输出带有：`/etc/rancher/k3s/k3s.yml`的信息。

这个时候将 KUBECONFIG 环境变量配置成这个路径即可正常使用。

短期配置：`export KUBECONFIG=/etc/rancher/k3s/k3s.yml`。

长期配置：

```shell
#打开文件
vim ~/.bashrc

#在文件末尾加上
export KUBECONFIG=/etc/rancher/k3s/k3s.yml   

#使设置生效
source ~/.bashrc
```

参考文章：[Linux之环境变量（永久设置） - 简书 (jianshu.com)](https://www.jianshu.com/p/9e32a0f9999c)

参考文章：https://stackoverflow.com/questions/66237953/can-not-find-kubeconfig-file

## 创建函数

参考文章：[Installing Fission | Fission](https://fission.io/docs/installation/)

```shell
# Add the stock Go env to your Fission deployment
$ fission env create --name go --image fission/go-env-1.16 --builder fission/go-builder-1.16

# A Go function that prints "hello world"
$ curl -LO https://raw.githubusercontent.com/fission/examples/main/go/hello-world/hello.go

# Upload your function code to fission
$ fission function create --name hello-go --env go --src hello.go --entrypoint Handler

# Wait for your source code to be built, package status should be succeeded. This may take a few minutes.
$ fission pkg list | grep hello-go
hello-go-8bb933b5-b12b-499b-a951-ee2245c8f1b5 succeeded    go     23 Nov 21 10:55 IST

# Test your function. This takes about 100msec the first time.
$ fission function test --name hello-go
Hello, world!
```

一般来说，会在`fission function create --name hello-go --env go --src hello.go --entrypoint Handler`指令的时候出现问题，这个时候查看 pod 会发现启动失败。使用`kubectl describe pod <pod-name> `查看后可以发现是镜像拉取问题，这就可以使用前面写的换源来换可用的源来主动拉取，一般来说，可能需要重复拉取两次。

所有的 pod 都启动后，执行后续步骤就不会出现问题了。

注意使用的编程语言的环境问题，如果版本过低，在 `fission pkg list` 里面是会显示创建失败的，所以最好选择使用高版本的环境，Go 推荐是 1.22。

## 创建 Faas 

参考文章：[Python3 Functions | Fission](https://fission.io/docs/usage/languages/python/)

因为使用 Go 语言编写比较复杂，所以选择使用 python。

```shell
fission environment create --name python --image fission/python-env
```

```python
def main():
    return "Hello, world!"
```

```shell
fission function create --name hello --env python --code hello.py 

$ fission function test --name hello
Hello, world!
```

### 关于 HTTP 的访问问题

一般来说，`$FISSION_ROUTER`环境变量在部署 fission 的时候就会写入，有的时候也不会。但是这个环境变量使用是会出错的。在 k3s 中，应该使用 k3s 的 IP。

 使用`kubectl get node -o wide` 命令输出节点的内部 IP 地址和外部 IP 地址。如果有外部 IP 地址，则将外部 IP 地址赋值给 `$FISSION_ROUTER`，如果没有，就将内部 IP 地址赋值给 `$FISSION_ROUTER`。

比如在我使用的嵌入式开发板上就是：

```shell
export FISSION_ROUTER=192.168.137.100:31314
curl -H "X-My-Header: Hello" $FISSION_ROUTER/headers
```
